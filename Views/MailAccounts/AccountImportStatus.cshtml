@inject Microsoft.Extensions.Localization.IStringLocalizer<MailArchiver.SharedResource> Localizer
@model MailArchiver.Models.AccountImportJob
@{
    ViewData["Title"] = Localizer["AccountImportStatusTitle"];
}

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>@Localizer["AccountImportStatusTitle"]</h1>
        <div>
            <a asp-action="Index" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> @Localizer["BackToAccounts"]
            </a>
            <a asp-controller="Emails" asp-action="Jobs" class="btn btn-outline-info">
                <i class="bi bi-list"></i> @Localizer["AllJobs"]
            </a>
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-light">
            <h5 class="mb-0">@Localizer["ImportJobInformation"]</h5>
        </div>
        <div class="card-body">
            <dl class="row">
                <dt class="col-sm-3">@Localizer["JobIDLabel"]</dt>
                <dd class="col-sm-9"><code>@Model.JobId</code></dd>

                <dt class="col-sm-3">@Localizer["StatusLabel"]</dt>
                <dd class="col-sm-9">
                    <span class="badge bg-@(Model.Status == MailArchiver.Models.AccountImportJobStatus.Running ? "primary" :
                                           Model.Status == MailArchiver.Models.AccountImportJobStatus.Completed ? "success" :
                                           Model.Status == MailArchiver.Models.AccountImportJobStatus.CompletedWithErrors ? "warning" :
                                           Model.Status == MailArchiver.Models.AccountImportJobStatus.Failed ? "danger" :
                                           Model.Status == MailArchiver.Models.AccountImportJobStatus.Cancelled ? "warning" : "secondary") fs-6">
                        @Localizer[Model.Status.ToString()]
                    </span>
                </dd>

                <dt class="col-sm-3">@Localizer["AccountsLabel"]</dt>
                <dd class="col-sm-9">
                    @if (Model.Status == MailArchiver.Models.AccountImportJobStatus.Running)
                    {
                        <span>@Model.ProcessedAccounts.ToString("N0") / @Model.TotalAccounts.ToString("N0") @Localizer["ProcessedSuffix"]</span>
                    }
                    else
                    {
                        <span>@Model.ProcessedAccounts.ToString("N0") / @Model.TotalAccounts.ToString("N0")</span>
                    }
                </dd>

                @if (Model.CurrentAccountEmail != null && Model.Status == MailArchiver.Models.AccountImportJobStatus.Running)
                {
                    <dt class="col-sm-3">@Localizer["CurrentAccountLabel"]</dt>
                    <dd class="col-sm-9">@Model.CurrentAccountEmail</dd>
                }

                <dt class="col-sm-3">@Localizer["CreatedLabel"]</dt>
                <dd class="col-sm-9">
                    <span class="utc-timestamp" data-utc-time="@Model.Created.ToString("yyyy-MM-ddTHH:mm:ss")">
                        @Model.Created.ToString("g")
                    </span>
                </dd>

                @if (Model.Started.HasValue)
                {
                    <dt class="col-sm-3">@Localizer["Started"]</dt>
                    <dd class="col-sm-9">
                        <span class="utc-timestamp" data-utc-time="@Model.Started.Value.ToString("yyyy-MM-ddTHH:mm:ss")">
                            @Model.Started.Value.ToString("g")
                        </span>
                    </dd>
                }

                @if (Model.Completed.HasValue)
                {
                    <dt class="col-sm-3">@Localizer["Completed"]</dt>
                    <dd class="col-sm-9">
                        <span class="utc-timestamp" data-utc-time="@Model.Completed.Value.ToString("yyyy-MM-ddTHH:mm:ss")">
                            @Model.Completed.Value.ToString("g")
                        </span>
                    </dd>

                    <dt class="col-sm-3">@Localizer["Duration"]</dt>
                    <dd class="col-sm-9">
                        @{
                            var duration = Model.Completed.Value - (Model.Started ?? Model.Created);
                        }
                        <span class="badge bg-info">@duration.ToString(@"hh\:mm\:ss")</span>
                    </dd>
                }
            </dl>
        </div>
    </div>

    @if (Model.Status == MailArchiver.Models.AccountImportJobStatus.Running || Model.Status == MailArchiver.Models.AccountImportJobStatus.Queued)
    {
        <div class="card mt-3">
            <div class="card-header bg-light">
                <h5 class="mb-0">@Localizer["Progress"]</h5>
            </div>
            <div class="card-body">
                @{
                    var progressPercent = Model.TotalAccounts > 0 ? (Model.ProcessedAccounts * 100.0 / Model.TotalAccounts) : 0;
                }
                <div class="progress mb-3" style="height: 25px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                         style="width: @progressPercent.ToString("F1", System.Globalization.CultureInfo.InvariantCulture)%"
                         aria-valuenow="@progressPercent.ToString("F0")" aria-valuemin="0" aria-valuemax="100">
                        @progressPercent.ToString("F0")%
                    </div>
                </div>
                <div class="row text-center">
                    <div class="col">
                        <span class="badge bg-success fs-6">@Model.SuccessCount</span>
                        <br><small class="text-muted">@Localizer["SuccessLabel"]</small>
                    </div>
                    <div class="col">
                        <span class="badge bg-danger fs-6">@Model.FailedCount</span>
                        <br><small class="text-muted">@Localizer["FailedLabel"]</small>
                    </div>
                    <div class="col">
                        <span class="badge bg-secondary fs-6">@Model.SkippedCount</span>
                        <br><small class="text-muted">@Localizer["SkippedLabel"]</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-3">
            <form asp-action="CancelAccountImport" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="jobId" value="@Model.JobId" />
                <button type="submit" class="btn btn-warning" onclick="return confirm('@Localizer["CancelImportConfirm"]');">
                    <i class="bi bi-stop-circle"></i> @Localizer["CancelImport"]
                </button>
            </form>
        </div>
    }

    @if (Model.Status == MailArchiver.Models.AccountImportJobStatus.Completed || 
         Model.Status == MailArchiver.Models.AccountImportJobStatus.CompletedWithErrors ||
         Model.Status == MailArchiver.Models.AccountImportJobStatus.Failed ||
         Model.Status == MailArchiver.Models.AccountImportJobStatus.Cancelled)
    {
        <div class="card mt-3">
            <div class="card-header bg-light">
                <h5 class="mb-0">@Localizer["AccountImportSummary"]</h5>
            </div>
            <div class="card-body">
                <div class="row text-center mb-3">
                    <div class="col">
                        <span class="badge bg-success fs-5">@Model.SuccessCount</span>
                        <br><small>@Localizer["SuccessLabel"]</small>
                    </div>
                    <div class="col">
                        <span class="badge bg-danger fs-5">@Model.FailedCount</span>
                        <br><small>@Localizer["FailedLabel"]</small>
                    </div>
                    <div class="col">
                        <span class="badge bg-secondary fs-5">@Model.SkippedCount</span>
                        <br><small>@Localizer["SkippedLabel"]</small>
                    </div>
                </div>
            </div>
        </div>

        @if (Model.Results.Any())
        {
            <div class="card mt-3">
                <div class="card-header bg-light">
                    <h5 class="mb-0">@Localizer["Details"]</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>@Localizer["EmailAddress"]</th>
                                    <th>@Localizer["Status"]</th>
                                    <th>@Localizer["Details"]</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var result in Model.Results)
                                {
                                    <tr>
                                        <td>@result.Email</td>
                                        <td>
                                            @if (result.Success)
                                            {
                                                <span class="badge bg-success">@Localizer["SuccessLabel"]</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-danger">@Localizer["FailedLabel"]</span>
                                            }
                                        </td>
                                        <td>@(result.ErrorMessage ?? "-")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }

        @if (!string.IsNullOrEmpty(Model.ErrorMessage))
        {
            <div class="alert alert-danger mt-3">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                @Model.ErrorMessage
            </div>
        }

        <div class="mt-3 d-flex gap-2">
            <a asp-action="ImportAccounts" class="btn btn-outline-success">
                <i class="bi bi-upload"></i> @Localizer["ImportMoreAccounts"]
            </a>
            <a asp-action="Index" class="btn btn-outline-primary">
                <i class="bi bi-person-gear"></i> @Localizer["ManageAccounts"]
            </a>
        </div>
    }
</div>

@section Scripts {
    @if (Model.Status == MailArchiver.Models.AccountImportJobStatus.Running || Model.Status == MailArchiver.Models.AccountImportJobStatus.Queued)
    {
        <script>
            setTimeout(function() { location.reload(); }, 5000);
        </script>
    }
}
